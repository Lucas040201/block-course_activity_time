/**
 * Languages configuration for the block_course_activity_time plugin.
 *
 * @package   block_course_activity_time
 * @copyright 2024, Lucas Mendes {@link https://www.lucasmendesdev.com.br}
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
*/ define(["jquery","core/templates","core/str","block_course_activity_time/repository","block_course_activity_time/modal",],function(t,e,i,a){let n={NOT_FOUND:"block_course_activity_time/components/students_progress/row_not_found_students",EMPTY:"block_course_activity_time/components/students_progress/row_empty_students",STUDENTS:"block_course_activity_time/components/students_progress/row_students"};async function o(t,i=!1){try{let o=r(t),c=await a.getStudents(o),l=n.STUDENTS;i||c.users.length||o.search||(l=n.EMPTY),i||c.users.length||!o.search||(s(t,"see_more"),l=n.NOT_FOUND),i||t.find(".course-activity-time-table-body").empty();let d=await e.render(l,{users:c.users,courseid:o.courseid});t.find(".total_students").text(c.total),t.find(".course-activity-time-table-body").append(d);let u=t.find(".students-item").length;c.total===u?s(t):t.find(".see_more").hasClass("hidden")&&c.total>u&&function t(e,i="see_more"){e.find(`.${i}`).removeClass("hidden"),e.find(`.${i}`).attr("disabled",!1)}(t)}catch(f){let m=await e.render(n.EMPTY);s(t),t.find(".course-activity-time-table-body").append(m)}}function s(t,e="see_more"){t.find(`.${e}`).addClass("hidden"),t.find(`.${e}`).attr("disabled",!0)}function r(t){return{courseid:Number(t.attr("data-courseid")),limit:Number(t.attr("data-limit")),page:Number(t.attr("data-page")),search:t.find("#search").val()||"",from:t.find("#from").val()||"",to:t.find("#to").val()||""}}function c(t){if(!t)return"00:00:00";let e=Math.floor(t/3600),i=Math.floor(t/60%60),a=t%60;return`${e=e<10?"0"+e:e}:${i=i<10?"0"+i:i}:${a=a<10?"0"+a:a}`}async function l(e){await o(e=t(e)),function t(e){e.find(".see_more").on("click",async function(){let t=Number(e.attr("data-page"))+1;e.attr("data-page",t),await o(e,r(e),!0)})}(e);let i;e.find("#search").on("keyup",t=>{clearTimeout(i),i=setTimeout(()=>{o(e)},2e3)}),e.find('[name="from"]').on("change",t=>{o(e)}),e.find('[name="to"]').on("change",t=>{o(e)}),function t(e){let i=function(t){let i=new Blob([t],{type:"text/csv"}),a=window.URL.createObjectURL(i),n=document.createElement("a");n.setAttribute("href",a);let o=e.find(".course-name").text();n.setAttribute("download",`${o}_${Math.floor(Date.now()/1e3)}.csv`),n.click()},n=function(t,e=!1){csvRows=[];let i=Object.values(t);return csvRows.push(i.join(";")),csvRows.join("\n")},o=async function(){let t=r(e),o=await a.exportData({courseId:Number(t.courseid)}),s=o.activities.map(t=>t.name),l=o.activities.map(t=>t.id),d=["Nome","E-mail",...s,"Total"].join(";"),u=o.users.map(t=>(t.total=t.activities.reduce((t,e)=>t+Number(e.totaltime),0),t)),f=[];for(let m of u){let $={name:m.fullname,email:m.email},p=l.map(t=>{let e=m.activities.find(e=>Number(e.moduleid)===Number(t));return e?c(e.totaltime):"00:00:00"});m.activities.map(t=>c(t.totaltime));let y=0,v={};for(;y<=s.length-1;)v[`activity${y}`]=p[y],y++;let h={...$,...v,total:c(m.total)};f.push(h)}let b="";f.forEach((t,e)=>{b+="\n"+n(t)});let g=d+b;i(g)};e.find(".export-data").on("click",o)}(e)}return{init:l}});