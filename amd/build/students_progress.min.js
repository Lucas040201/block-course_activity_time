/**
 * Languages configuration for the block_course_activity_time plugin.
 *
 * @package   block_course_activity_time
 * @copyright 2024, Lucas Mendes {@link https://www.lucasmendesdev.com.br}
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
*/ define(["jquery","core/templates","core/str","block_course_activity_time/repository","block_course_activity_time/modal",],function(t,e,a,i){let n={NOT_FOUND:"block_course_activity_time/components/students_progress/row_not_found_students",EMPTY:"block_course_activity_time/components/students_progress/row_empty_students",STUDENTS:"block_course_activity_time/components/students_progress/row_students"};async function o(t,a=!1){try{let o=r(t),c=await i.getStudents(o),l=n.STUDENTS;a||c.users.length||o.search||(l=n.EMPTY),a||c.users.length||!o.search||(s(t,"see_more"),l=n.NOT_FOUND),a||t.find(".course-activity-time-table-body").empty();let d=await e.render(l,{users:c.users,courseid:o.courseid});t.find(".total_students").text(c.total),t.find(".course-activity-time-table-body").append(d);let u=t.find(".students-item").length;c.total===u?s(t):t.find(".see_more").hasClass("hidden")&&c.total>u&&function t(e,a="see_more"){e.find(`.${a}`).removeClass("hidden"),e.find(`.${a}`).attr("disabled",!1)}(t)}catch(f){let m=await e.render(n.EMPTY);s(t),t.find(".course-activity-time-table-body").append(m)}}function s(t,e="see_more"){t.find(`.${e}`).addClass("hidden"),t.find(`.${e}`).attr("disabled",!0)}function r(t){return{courseid:Number(t.attr("data-courseid")),limit:Number(t.attr("data-limit")),page:Number(t.attr("data-page")),search:t.find("#search").val()||"",from:t.find("#from").val()||"",to:t.find("#to").val()||""}}function c(t){return t?`${Math.floor(t/3600)}:${Math.floor(t/60%60)}:${t%60}`:"00:00:00"}async function l(e){await o(e=t(e)),function t(e){e.find(".see_more").on("click",async function(){let t=Number(e.attr("data-page"))+1;e.attr("data-page",t),await o(e,r(e),!0)})}(e);let a;e.find("#search").on("keyup",t=>{clearTimeout(a),a=setTimeout(()=>{o(e)},2e3)}),e.find('[name="from"]').on("change",t=>{o(e)}),e.find('[name="to"]').on("change",t=>{o(e)}),function t(e){let a=function(t){let a=new Blob([t],{type:"text/csv"}),i=window.URL.createObjectURL(a),n=document.createElement("a");n.setAttribute("href",i);let o=e.find(".course-name").text();n.setAttribute("download",`${o}_${Math.floor(Date.now()/1e3)}.csv`),n.click()},n=function(t,e=!1){csvRows=[];let a=Object.values(t);return csvRows.push(a.join(";")),csvRows.join("\n")},o=async function(){let t=r(e),o=await i.exportData({courseId:Number(t.courseid)}),s=o.activities.map(t=>t.name),l=["Nome","E-mail",...s,"Total"].join(";"),d=o.users.map(t=>(t.total=t.activities.reduce((t,e)=>t+Number(e.totaltime),0),t)),u=[];for(let f of d){let m={name:f.fullname,email:f.email},p=f.activities.map(t=>c(t.totaltime)),$=0,y={};for(;$<=s.length-1;)y[`activity${$}`]=p[$]??"00:00:00",$++;let h={...m,...y,total:c(f.total)};u.push(h)}let v="";u.forEach((t,e)=>{v+="\n"+n(t)});let b=l+v;a(b)};e.find(".export-data").on("click",o)}(e)}return{init:l}});